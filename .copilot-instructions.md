# Copilot Instructions for Verifactu PHP Library

## Library Overview

This is **Verifactu PHP**, a modern PHP library for integrating with Spain's AEAT (Agencia Estatal de Administración Tributaria) Verifactu system. Verifactu is the Spanish tax authority's digital invoice submission, validation, and tracking system.

### Key Purpose
- **Invoice Registration (Alta)**: Submit invoices to AEAT
- **Invoice Cancellation (Anulación)**: Cancel previously submitted invoices
- **Invoice Querying**: Retrieve submitted invoice information
- **QR Code Generation**: Generate verification QR codes for invoices
- **XML Signing**: Handle XAdES enveloped signatures for compliance
- **Error Handling**: Translate AEAT error codes to human-readable messages

### Core Requirements
- **Framework Agnostic**: No dependencies on specific PHP frameworks
- **PHP 8.1+ Compatible**: Uses modern PHP features (enums, match expressions, etc.)
- **PSR Compliant**: Follows PSR-4 autoloading and coding standards
- **DRY Principle**: Don't Repeat Yourself - reusable, modular components
- **Composer Installable**: Standard Composer package management

## Architecture Patterns

### Namespace Structure
```
eseperio\verifactu\
├── models\           # Data models with validation
├── services\         # Business logic services
├── dictionaries\     # Error codes and mappings
└── Verifactu.php    # Main facade class
```

### Design Patterns Used

#### 1. **Facade Pattern**
- Main `Verifactu` class provides static methods as simple entry points
- Hides complex service orchestration behind clean API
```php
Verifactu::config($certPath, $password, $type, $environment);
Verifactu::registerInvoice($invoice);
Verifactu::cancelInvoice($cancellation);
```

#### 2. **Abstract Model Pattern**
- All models extend abstract `Model` base class
- Provides validation framework and common functionality
- Each model implements `rules()` method for validation rules
- Models handle XML conversion via `toXml()` method

#### 3. **Service Layer Pattern**
- Services in `src/services/` handle specific responsibilities:
  - `VerifactuService`: Main orchestration service
  - `XmlSignerService`: XML digital signature handling
  - `SoapClientFactoryService`: SOAP client management
  - `QrGeneratorService`: QR code generation
  - `HashGeneratorService`: Hash calculation for invoices
  - `CertificateManagerService`: Certificate management
  - `ResponseParserService`: AEAT response parsing
  - `EventDispatcherService`: Event handling

#### 4. **Registry Pattern**
- `ErrorRegistry` contains AEAT error code mappings
- Centralized error message translations

## Code Style and Conventions

### PHP Version Features
- **PHP 8.1+ Enums**: Use for type-safe constants (InvoiceType, RectificationType, etc.)
- **Match Expressions**: Preferred over switch statements
- **Constructor Property Promotion**: Use when appropriate
- **Typed Properties**: Always declare property types
- **Return Type Declarations**: Always specify return types

### Naming Conventions
- **Classes**: PascalCase (`InvoiceSubmission`, `VerifactuService`)
- **Methods**: camelCase (`registerInvoice`, `generateQr`)
- **Properties**: camelCase (`$issuerName`, `$invoiceDate`)
- **Constants**: SCREAMING_SNAKE_CASE (`ENVIRONMENT_PRODUCTION`)
- **Enums**: PascalCase with descriptive values (`InvoiceType::STANDARD`)

### Documentation Standards
- **Class DocBlocks**: Include purpose, schema references for models
- **Method DocBlocks**: Parameters, return types, exceptions
- **Property DocBlocks**: Type, purpose, examples for complex structures
- **Spanish Context**: Reference official AEAT documentation when relevant

### PSR Compliance
- **PSR-4 Autoloading**: Namespace matches directory structure
- **PSR-12 Coding Style**: Follow extended coding style guide
- **PSR-1 Basic Coding Standards**: Class names, method names, constants

## Model Development Patterns

### Base Model Structure
All models extend `eseperio\verifactu\models\Model`:

```php
<?php
namespace eseperio\verifactu\models;

class YourModel extends Model
{
    // Typed properties with documentation
    public string $requiredField;
    public ?string $optionalField = null;
    
    // Validation rules implementation
    public function rules(): array
    {
        return [
            [['requiredField'], 'required'],
            [['optionalField'], 'string'],
            // Custom validators as callables
            [['customField'], function($value) {
                return is_valid($value) ? true : 'Custom error message';
            }]
        ];
    }
    
    // XML conversion (if needed)
    public function toXml(): string
    {
        // Implementation specific to AEAT XML structure
    }
}
```

### Validation Patterns
- **Built-in Validators**: 'required', 'string', 'integer', 'email', etc.
- **Custom Validators**: Use callable functions for complex validation
- **Array Properties**: Use arrays for handling multiple properties
- **Getter/Setter Support**: Models support getter methods for computed properties

### Model Relationships
- **Composition**: Models can contain other models as properties
- **Enums**: Use PHP 8.1 enums for type-safe value constraints
- **Arrays**: Use typed arrays for collections (e.g., `array` of `InvoiceRecord`)

## Service Development Patterns

### Service Responsibilities
- **Single Responsibility**: Each service handles one specific domain
- **Static Methods**: Services often use static methods for stateless operations
- **Configuration**: Services receive configuration through dependency injection or static config
- **Error Handling**: Services translate technical errors to domain-specific exceptions

### Common Service Patterns
```php
<?php
namespace eseperio\verifactu\services;

class YourService
{
    // Static configuration
    protected static array $config = [];
    
    public static function config(array $data): void
    {
        self::$config = $data;
    }
    
    // Main service methods
    public static function performOperation(Model $input): ResponseModel
    {
        // Validate input
        $validation = $input->validate();
        if ($validation !== true) {
            throw new ValidationException($validation);
        }
        
        // Perform operation
        // Return typed response
    }
}
```

## Testing Patterns

### Test Structure
- **PHPUnit 10+**: Use latest PHPUnit features
- **Unit Tests**: Focus on individual model/service testing
- **Test Organization**: Mirror source structure in `tests/` directory
- **Namespace**: `eseperio\verifactu\tests\`

### Testing Models
```php
public function testModelValidation(): void
{
    $model = new YourModel();
    
    // Test validation failure
    $result = $model->validate();
    $this->assertNotTrue($result);
    $this->assertArrayHasKey('requiredField', $result);
    
    // Test validation success
    $model->requiredField = 'valid value';
    $this->assertTrue($model->validate());
}
```

### Testing Services
- **Mock External Dependencies**: SOAP clients, file systems, etc.
- **Test Configuration**: Verify service configuration handling
- **Exception Testing**: Test error conditions and exception handling

## AEAT/Verifactu Context

### Spanish Tax System Understanding
- **NIF/CIF**: Spanish tax identification numbers
- **Factura**: Invoice in Spanish tax context
- **AEAT**: Spanish tax authority (Agencia Estatal de Administración Tributaria)
- **BOE**: Official State Gazette (legal framework references)

### Regulatory Compliance
- **XAdES Signatures**: XML Advanced Electronic Signatures for legal compliance
- **Hash Calculation**: Specific algorithms mandated by AEAT
- **QR Codes**: Verification QR codes following AEAT specifications
- **XML Schemas**: Strict adherence to official AEAT XSD schemas

### Documentation References
- Official AEAT documentation in `docs/aeat/` directory
- Schema files (`.xsd.xml`) define data structures
- Error code documentation for troubleshooting
- Technical specifications for hash algorithms and QR generation

## Error Handling Patterns

### Exception Hierarchy
- Use descriptive exception classes
- Include AEAT error codes when available
- Provide multilingual error messages (Spanish/English)

### Error Registry Usage
```php
use eseperio\verifactu\dictionaries\ErrorRegistry;

// Translate AEAT error codes
$errorMessage = ErrorRegistry::getErrorMessage($code);
```

## Security Considerations

### Certificate Management
- Handle PKCS#12 certificates securely
- Never commit certificates or passwords to version control
- Support both individual and seal certificates
- Proper certificate validation and expiration handling

### XML Security
- Validate all XML against official schemas
- Implement secure XML parsing to prevent XXE attacks
- Proper XML signature validation

## Environment Management

### Configuration Patterns
- Support both production and sandbox environments
- Environment-specific endpoints and URLs
- Certificate type handling (individual vs. seal)
- Proper environment isolation in tests

### Deployment Considerations
- Composer installation requirements
- PHP extension dependencies (soap, openssl, dom, libxml)
- Certificate file management in production
- Error logging and monitoring

## Contributing Guidelines

### Code Quality
- All code must pass existing tests
- New features require corresponding tests
- Follow existing code style and patterns
- Document new functionality thoroughly

### Git Workflow
- Feature branches from main/develop
- Descriptive commit messages
- Reference issue numbers in commits
- Keep commits focused and atomic

### Pull Request Requirements
- Update CHANGELOG.md for significant changes
- Add/update tests for new functionality
- Update documentation as needed
- Ensure PSR compliance and coding standards

This library is specifically designed for Spanish businesses and developers integrating with the AEAT Verifactu system. Understanding the Spanish tax context and regulatory requirements is essential for effective contribution.